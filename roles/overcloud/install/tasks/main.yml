- name: Wait for at least one node to be available
  shell: >
    source /home/stack/stackrc;
    nova hypervisor-stats
  register: nodes
  until: nodes.stdout.find("count                | 0") == -1
  retries: 10
  delay: 10

- name: Create overcloud deploy script
  template:
    src="deploy_overcloud.j2"
    dest="/home/stack/deploy_overcloud.sh"
    mode=0755

- name: Create odl yml
  template:
    src="odl.j2"
    dest="/home/stack/odl.yml"
    mode=0755

- name: Deploy overcloud roles
  copy:
    src='overcloud_roles.yaml'
    dest=/home/stack/overcloud_roles.yaml
    mode=0755

- name: Deploy Overcloud
  shell: >
    source /home/stack/stackrc;
    bash /home/stack/deploy_overcloud.sh &> overcloud_deployment.log
  register: overcloud_deployment_result
  failed_when: overcloud_deployment_result.rc != 0
