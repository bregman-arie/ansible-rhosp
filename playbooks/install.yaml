# Undercloud
# ----------
- name: Prepare undercloud for RHOSP 10 installation
  hosts: undercloud
  vars:
    ansible_ssh_user: root
  roles:
    - { role: undercloud/prepare_host }
    - { role: undercloud/setup_stack_user }
    - { role: undercloud/setup_conf_file }

- name: Install undercloud
  hosts: undercloud
  vars:
    ansible_ssh_user: stack
  roles:
    - { role: undercloud/install }

- name: Post undercloud installation
  hosts: undercloud
  vars:
    ansible_ssh_user: root
  roles:
    - { role: undercloud/post_installation }

# Overcloud
# ---------

- name: Install Overcloud
  hosts: undercloud
  vars:
    ansible_ssh_user: stack
  roles:
    - { role: overcloud/setup }
    - { role: overcloud/setup_images }
    - { role: overcloud/register_nodes }
    - { role: overcloud/set_templates }
    - { role: overcloud/install }

- name: Post overcloud installation
  hosts: undercloud
  vars:
    ansible_ssh_user: stack
  roles:
    - { role: overcloud/post_installation }

- name: resize lvm
  hosts: controller
  become: True
  tasks:
     - command: chdir=/var/lib/cinder/ {{ item }}
       with_items:
          - df -h
          - dd if=/dev/zero of=cinder-volumes2 bs=102400 count=409600
          - df -h
          - losetup /dev/loop3 /var/lib/cinder/cinder-volumes2
          - losetup -l
          - pvdisplay 
          - vgdisplay 
          - pvcreate /dev/loop3
          - vgextend cinder-volumes /dev/loop3
          - pvdisplay
          - vgdisplay
          - systemctl restart openstack-cinder-*

# Localhost
# ---------
- name: Update inventory with overcloud nodes
  hosts: localhost
  roles:
    - { role: overcloud/update_inventory }
